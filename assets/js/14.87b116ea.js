(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{430:function(t,s,a){"use strict";a.r(s);var e=a(2),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"分布式锁"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分布式锁"}},[t._v("#")]),t._v(" 分布式锁")]),t._v(" "),s("ul",[s("li",[t._v("解释:分布式系统中的锁，解决分布式系统中控制共享资源")]),t._v(" "),s("li",[t._v("必须具备的条件\n"),s("ul",[s("li",[t._v("一个方法在同一时间只能被一台机器的一个线程执行")]),t._v(" "),s("li",[t._v("高可用的获取锁和释放锁")]),t._v(" "),s("li",[t._v("高性能的获取锁和释放锁")]),t._v(" "),s("li",[t._v("具备可重入特性")]),t._v(" "),s("li",[t._v("具备锁失效机制，防止死锁")]),t._v(" "),s("li",[t._v("具备非阻塞特性，即没有获得锁直接返回获取锁失败")])])]),t._v(" "),s("li",[t._v("实现方式\n"),s("ul",[s("li",[t._v("基于数据库实现"),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DROP")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("IF")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXISTS")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("method_lock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("method_lock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AUTO_INCREMENT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COMMENT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'主键'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("method_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("varchar")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COMMENT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'锁定的方法名'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("tinyint")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COMMENT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1:未分配；2：已分配'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("update_time"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("timestamp")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CURRENT_TIMESTAMP")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ON")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UPDATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CURRENT_TIMESTAMP")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("version"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COMMENT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'版本号'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("PRIMARY KEY ("),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v("id"),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("),\n   UNIQUE KEY "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v("uidx_method_name"),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v(" ("),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v("method_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("USING")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BTREE")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("InnoDB")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AUTO_INCREMENT")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CHARSET")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf8 "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COMMENT")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'锁定中的方法'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("ul",[s("li",[t._v("先获取锁的信息\n"),s("blockquote",[s("p",[t._v("select id, method_name, state,version from method_lock where state=1 and method_name='methodName';")])])]),t._v(" "),s("li",[t._v("占有锁\n"),s("blockquote",[s("p",[t._v("update t_resoure set state=2, version=2, update_time=now() where method_name='methodName' and state=1 and version=2;")])])]),t._v(" "),s("li",[t._v("如果更新成功则获取锁成功，否则该锁已经被别人占用")]),t._v(" "),s("li",[t._v("缺点：强依赖数据库可用性，且数据库是一个单点，无法保证可用性；没有失效时间，解锁操作失败会造成死锁；非阻塞；非重入")]),t._v(" "),s("li",[t._v("解决方案：单点部署多台实现主从复制；失效时间可以创建一个定时任务，定时清理失效数据；非阻塞可以使用while循环，直到成功再返回成功；非重入可以在表中加入线程id和机器信息，判断是否当前机器当前线程获得的锁，如果是直接分配")])])]),t._v(" "),s("li",[t._v("基于缓存（Redis）实现\n"),s("ul",[s("li",[t._v("设置锁：setnx命令，set if not exists，当且仅当key不存在时，才会设置key的value值，如果存在，则不做任何动作")]),t._v(" "),s("li",[t._v("获取锁：get key，如果存在key直接返回，如果不存在，返回nil")]),t._v(" "),s("li",[t._v("释放锁：del key，删除存在的key")]),t._v(" "),s("li",[t._v("缺点：线程获得锁之后突然宕机，来不及执行释放锁命令会造成死锁；设置了超时时间之后由于执行任务时间过长，导致锁释放，另一个线程获取锁，后面任务完成，前一个线程释放了后面一个线程获取的锁；同一时间有两个线程在执行共享方法，这不符合分布式锁要求；主从模式下，当一个线程获取锁成功之后，主从复制还没有执行，主突然宕机，会存在锁丢失的风险")]),t._v(" "),s("li",[t._v("解决方案：设置锁超时时间；在value值中添加线程信息或者机器编号，释放时判断是否是属于自己的锁；使用守护线程，每当锁快要到过期时间，守护线程会给锁续期，如果当前机器在没有释放锁宕机，那么执行线程和守护线程处于同一个进程，锁超过时间会自动释放；无法解决，默认最低发生概率，可以忍受")])])]),t._v(" "),s("li",[t._v("基于zookeep实现\n"),s("ul",[s("li",[t._v("设置锁：首先，在zookeep中创建一个持久节点ParentLock，当有客户端想要获取锁时，需要在Parentlock节点下创建临时顺序节点Lock，创建完成之后，客户端会检查自己所创建的临时顺序节点是否是最靠前的一个，如果是，则获取锁成功，如果不是，则向比他靠前一个的节点注册Watcher事件，用来监听节点是否存在，这就意味着进入等待状态，后面客户端依次类推")]),t._v(" "),s("li",[t._v("释放锁：当客户端任务完成时，会显式的调用删除节点命令，如果客户端在执行任务过程中宕机，同时也会和zookeep连接断开，所以根据临时节点的特性，也会随之由zookeeper主动删除")]),t._v(" "),s("li",[t._v("缺点：在性能方面，可能没有缓存那么高，每次都要创建和删除节点，且每次zookeeper每次都要同步数据到所有的Follower节点；还有就是可能由于网络抖动原因，zookeeper会判断客户端心跳消失而删除对应节点")]),t._v(" "),s("li",[t._v("解决方案：对于网络抖动而言，zookeeper有重试机制，可以根据网络抖动发生的次数和时间来相应的调整重试次数和时间")])])])])]),t._v(" "),s("li",[t._v("分布式CAP理论\n"),s("ul",[s("li",[t._v("一致性（Consistency）")]),t._v(" "),s("li",[t._v("可用性（Availability)")]),t._v(" "),s("li",[t._v("分区容错性（Partition tolerance)")])])])])])}),[],!1,null,null,null);s.default=n.exports}}]);